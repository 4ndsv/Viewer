<html>

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
          crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="imgareaselect-default.css" />
    <script type="text/javascript" src="jquery.imgareaselect.pack.js"></script>
</head>

<body>
    <div class="container">
        <!-- Container principal para imagem -->
        <div class="imageContent">
            <div class="row">
                <span style="margin-left:auto;margin-right:auto">
                    <button class="btn btn-light" onclick='img.zoom(this,"in")'>+</button>
                    <button class="btn btn-light" onclick='img.zoom(this,"out")'>-</button>
                    <button class="btn btn-light" onclick='img.rotate(this,"left")'>Rotate Left</button>
                    <button class="btn btn-light" onclick='img.rotate(this,"right")'>Rotate Right</button>
                    <button class="btn btn-light" onclick='img.autoFocus(this)'>Focus</button>
                    <button class="btn btn-light" onclick='img.areaFocus(this)'>Area</button>
                </span>
            </div>
            <div class="row" id="divImgClone" style="overflow:auto;position:absolute; width:180px; height:80px;overflow:hidden;margin:0 auto;left:50%;margin-left:-90px; border-radius:4px;z-index:1;">
                <div class="image imageClone" style="background-color:rgba(255, 255, 255, 0.26)">
                </div>
            </div>
            <div class="row" style="background-color: lightgray;border:solid red; overflow:auto;">
                <div class='image imageDefault' style="margin-left:auto;margin-right:auto;background-color: gray;">
                    <img src="http://localhost/Capturar.PNG" alt="" />
                </div>
            </div>
        </div>
    </div>

    <script>
        var img = {
            eventEnable: false,
            eventFinish: false,
            rotateValue: 0,
            init: function (el) {
                $(el).attr('zoomPercent', '100').attr('rotate', '0');
                $('#divImgClone').css('margin-top', $('.imageDefault').height() - 82);
                $('.imageDefault').css('max-height', $('.imageDefault').height());
            },
            zoom: function (t, i) {
                var obj = $(t).closest('.imageContent').find('.imageDefault');
                if (i == 'in') {
                    $(obj).attr('zoomPercent', +$(obj).attr('zoomPercent') + +10);
                } else if (i == 'out') {
                    $(obj).attr('zoomPercent', +$(obj).attr('zoomPercent') - +10);
                }
                this.applyTransform(obj);
            },
            rotate: function (t, direction) {
                if (direction == 'left') {
                    img.rotateValue = -90;
                } else if (direction == 'right') {
                    img.rotateValue = 90;
                }
                var imageDefault = $(t).closest('.imageContent').find('.imageDefault img')[0];
                var tnCanvas = document.createElement('canvas');
                var tnCanvasContext = tnCanvas.getContext('2d');

                tnCanvasContext.save();
                tnCanvas.width = imageDefault.naturalHeight;
                tnCanvas.height = imageDefault.naturalWidth;
                tnCanvasContext.translate(direction == 'right' ? imageDefault.height : 0, direction == 'left' ? imageDefault.width : 0);

                tnCanvasContext.rotate(img.rotateValue * Math.PI / 180);
                tnCanvasContext.drawImage(imageDefault, 0, 0, imageDefault.width, imageDefault.height);
                var newUrl = tnCanvas.toDataURL();
                tnCanvasContext.restore();
                imageDefault.remove();
                $(t).closest('.imageContent').find('.imageDefault')[0].innerHTML = '<img src="' + newUrl + '" />';
            },
            autoFocus: function (t) {
                var obj = $(t).closest('.imageContent').find('.imageDefault');
                obj.css('transform', 'matrix(1, 0, 0, 1, 0, 0)');
                $(obj).attr('zoomPercent', '100').attr('rotate', '0');

                if (img.eventEnable) {
                    img.removeAutoFocus(t);
                    return;
                }
                var imgObject = $('.imageDefault img')[0];
                var divImgClone = $('#divImgClone')[0];
                $(obj)
                    .on('mouseout', function () {
                        $('.imageClone img').remove();
                    })
                    .on('mousemove', function (e) {
                        debugger;
                        var newUrl = img.getImagePortion(imgObject, divImgClone.offsetWidth / 2, divImgClone.offsetHeight / 2, e.pageX - $(this).offset().left - 45, e.pageY - $(this).offset().top - 20, 1);
                        $('.imageClone')[0].innerHTML = '<img id="imgClone" style="transform-origin: 0% 0%;transform:matrix(2.0,0,0,2.0,0,0)" src="' + newUrl + '" />';
                    });

                $('body').click(function () {
                    if (img.eventFinish)
                        img.removeAutoFocus(t);
                    else
                        img.eventFinish = true;
                });
                img.eventEnable = true;
            },
            areaFocus: function (t) {
                var obj = $(t).closest('.imageContent').find('.imageDefault');
                obj.css('transform', 'matrix(1, 0, 0, 1, 0, 0)');
                $(obj).attr('zoomPercent', '100').attr('rotate', '0');

                if (img.eventEnable) {
                    img.removeAreaFocus(t);
                    return;
                }

                var objImg = $(obj).find('img');
                objImg.imgAreaSelect({ onSelectEnd: img.calcAreaPreview, maxWidth: $('#divImgClone').width() * 0.80, maxHeight: $('#divImgClone').height() * 0.80 });
            },
            removeAutoFocus: function (t) {
                var obj = $(t).closest('.imageContent').find('.imageDefault');
                $(obj).unbind('mouseover').unbind('mouseout').unbind('mousemove');

                $('body').unbind('click');
                img.eventEnable = false;
                img.eventFinish = false;
                $('.imageClone img').remove();
            },
            removeAreaFocus: function () {
                $('body').unbind('click');
                img.eventEnable = false;
                img.eventFinish = false;
                $('.imageClone img').remove();
            },
            percentToScale: function (percent) {
                return percent.toString()[0] + '.' + percent.toString()[1] + percent.toString()[2];
            },
            applyTransform: function (obj) {
                var scale = this.percentToScale($(obj).attr('zoomPercent'));
                $(obj).css('transform', 'matrix(' + scale + ',0,0,' + scale + ',0,0) rotate(' + $(obj).attr('rotate') + 'deg)');
            },
            getTransform: function (t) {
                $(t).closest('.imageContent').find('.image');
            },
            getImagePortion: function (imgObj, newWidth, newHeight, startX, startY, ratio) {
                var tnCanvas = document.createElement('canvas');
                var tnCanvasContext = tnCanvas.getContext('2d');

                var bufferCanvas = document.createElement('canvas');
                var bufferContext = bufferCanvas.getContext('2d');
                bufferCanvas.width = imgObj.naturalWidth;
                bufferCanvas.height = imgObj.naturalHeight;
                bufferContext.drawImage(imgObj, 0, 0);

                tnCanvasContext.drawImage(bufferCanvas, startX, startY, newWidth * ratio, newHeight * ratio, 0, 0, newWidth, newHeight);
                return tnCanvas.toDataURL();
            },
            calcAreaPreview: function (objImg, selection) {
                var newUrl = img.getImagePortion(objImg, selection.width, selection.height, selection.x1, selection.y1, 1);

                $('.imageClone')[0].innerHTML = '<img id="imgClone" style="transform-origin: 0% 0%;transform:matrix(1.25,0,0,1.25,0,0)" src="' + newUrl + '" />';

                $('.imageDefault img').imgAreaSelect({ remove: true });

                img.eventFinish = false;
                $('body').click(function () {
                    if (img.eventFinish)
                        img.removeAreaFocus();
                    else
                        img.eventFinish = true;
                });
                img.eventEnable = true;
            }
        }
        $(window).ready(function () {
            img.init('.imageContent .imageDefault');
        });
    </script>
</body>

</html>